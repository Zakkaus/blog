---
slug: cloudflare-stats-worker-deploy
title: "Cloudflare Stats Worker - éš±ç§å„ªå…ˆçš„çµ±è¨ˆå„€è¡¨æ¿"
date: 2025-01-08
tags: ["Cloudflare", "Analytics", "Workers", "Privacy"]
categories: ["Infrastructure"]
description: "éƒ¨ç½²ä½ è‡ªå·±çš„éš±ç§å„ªå…ˆçµ±è¨ˆå„€è¡¨æ¿,å°±åƒ stats.zakk.au ä¸€æ¨£ä½¿ç”¨ Cloudflare Workers"
translationKey: "cloudflare-stats-deploy"
authors:
  - "Zakk"
---

æƒ³è¦å³æ™‚ç¶²ç«™çµ±è¨ˆå»ä¸æƒ³ç”¨ Google Analytics?**Cloudflare Stats Worker** æ˜¯ä¸€å€‹å®Œå…¨é‹è¡Œåœ¨ Cloudflare é‚Šç·£ç¶²è·¯ä¸Šçš„éš±ç§å„ªå…ˆåˆ†ææ–¹æ¡ˆã€‚

çœ‹çœ‹å¯¦éš›æ¡ˆä¾‹ï¼š**[stats.zakk.au](https://stats.zakk.au/)**

![çµ±è¨ˆå„€è¡¨æ¿](stats-dashboard.webp)

## ç‚ºä»€éº¼é¸æ“‡ Cloudflare Stats Worker?

- **éš±ç§å„ªå…ˆ**ï¼šç„¡ Cookieï¼ŒIP ä½å€ç¶“ SHA-256 é›œæ¹Šä¸¦æˆªæ–·
- **é›¶æˆæœ¬**ï¼šå¤§å¤šæ•¸å€‹äººç¶²ç«™ä½¿ç”¨ Cloudflare å…è²»æ–¹æ¡ˆå³å¯é‹è¡Œ
- **é‚Šç·£æ•ˆèƒ½**ï¼šåŸºæ–¼ Cloudflare Workers + KVï¼Œå…¨çƒä½å»¶é²è¨ªå•
- **å¤šèªè¨€æ”¯æ´**ï¼šè‡ªå‹•æ­£è¦åŒ–ä¸åŒèªè¨€ç‰ˆæœ¬çš„è·¯å¾‘
- **å®Œæ•´æ–¹æ¡ˆ**ï¼šå–®ä¸€ Worker åŒæ™‚æä¾› API ç«¯é»èˆ‡ç¨ç«‹å„€è¡¨æ¿

## ä¸»è¦ç‰¹è‰²

### å³æ™‚åˆ†æ
- ä»Šæ—¥ PV/UV å³æ™‚è¨ˆæ•¸å™¨
- 7/14/30 å¤©æ­·å²è¶¨å‹¢
- ç†±é–€é é¢ Top 10 æ’è¡Œ

### ç²¾ç¾å„€è¡¨æ¿
- ç»ç’ƒæ“¬æ…‹è¨­è¨ˆï¼Œæ”¯æ´æ·±æ·ºè‰²ä¸»é¡Œ
- éŸ¿æ‡‰å¼ä½ˆå±€ï¼Œæ”¯æ´æ‰‹æ©Ÿèˆ‡æ¡Œé¢
- å¤šèªè¨€ä»‹é¢ï¼ˆç¹ä¸­/è‹±æ–‡ï¼‰
- å¯é€éè‡ªè¨‚ç¶²åŸŸè¨ªå•ï¼ˆå¦‚ stats.example.comï¼‰

### é–‹ç™¼è€…å‹å–„ API
- RESTful API ç«¯é»ï¼Œæ–¹ä¾¿è‡ªè¨‚æ•´åˆ
- æ‰¹æ¬¡æ“ä½œï¼Œé«˜æ•ˆè³‡æ–™æŸ¥è©¢
- å¥åº·æª¢æŸ¥ç«¯é»ï¼Œä¾¿æ–¼ç›£æ§

## å¿«é€Ÿéƒ¨ç½²

> éœ€æ±‚ï¼šNode.js â‰¥ 18ã€`wrangler` CLI â‰¥ 3.0

1. **è¤‡è£½ä¸¦é€²å…¥å°ˆæ¡ˆç›®éŒ„**
   ```bash
   git clone https://github.com/Zakkaus/cloudflare-stats-worker.git
   cd cloudflare-stats-worker
   ```

2. **å®‰è£ Wrangler ä¸¦ç™»å…¥**
   ```bash
   npm install -g wrangler
   wrangler login
   ```

3. **å»ºç«‹ KV å‘½åç©ºé–“**
   ```bash
   wrangler kv namespace create PAGE_STATS
   wrangler kv namespace create PAGE_STATS --preview
   ```
   ç„¶å¾Œå°‡ ID è²¼åˆ° `wrangler.toml` ä¸­ã€‚

4. **ï¼ˆå¯é¸ï¼‰å•Ÿç”¨ D1 ä»¥æ”¯æ´è¶¨å‹¢åœ–èˆ‡ç†±é–€é é¢**
   ```bash
   wrangler d1 create cloudflare-stats-top
   wrangler d1 execute cloudflare-stats-top --file=schema.sql --remote
   ```
   è§£é™¤ `wrangler.toml` ä¸­ `d1_databases` å€å¡Šçš„è¨»è§£ï¼Œä¸¦å¡«å…¥ç”Ÿæˆçš„ IDã€‚

5. **éƒ¨ç½² ğŸ‰**
   ```bash
   wrangler deploy
   ```

## æ­¥é©Ÿ 7ï¼šè¨ªå•çµ±è¨ˆå„€è¡¨æ¿

éƒ¨ç½²å®Œæˆå¾Œï¼Œç›´æ¥è¨ªå•ä½ çš„å„€è¡¨æ¿ç¶²åŸŸï¼š

```
https://stats.example.com/
```

ä½ æœƒçœ‹åˆ°èˆ‡ [stats.zakk.au](https://stats.zakk.au/) ç›¸åŒçš„ç²¾ç¾åˆ†æä»‹é¢ï¼š

- **å³æ™‚æŒ‡æ¨™**ï¼šä»Šæ—¥ PV/UV å¡ç‰‡å³æ™‚æ›´æ–°
- **API å¥åº·ç‹€æ…‹**ï¼šè¦–è¦ºåŒ–ç³»çµ±ç‹€æ…‹æŒ‡ç¤ºå™¨
- **è¶¨å‹¢åœ–è¡¨**ï¼š7/14/30 å¤©äº’å‹•å¼åœ–è¡¨
- **ç†±é–€é é¢**ï¼šæœ€å—æ­¡è¿å…§å®¹æ’è¡Œæ¦œ
- **ä¸»é¡Œåˆ‡æ›**ï¼šæ·±æ·ºè‰²æ¨¡å¼è‡ªç”±åˆ‡æ›
- **èªè¨€é¸æ“‡å™¨**ï¼šç¹ä¸­/è‹±æ–‡ä»‹é¢é¸é …

å„€è¡¨æ¿å®Œå…¨ç¨ç«‹é‹ä½œ - ç„¡éœ€åµŒå…¥ï¼Œç›´æ¥åˆ†äº«ç¶²å€å³å¯ï¼

## å…è²»æ–¹æ¡ˆèˆ‡å‡ç´šé¸é …

| æœå‹™ | å…è²»é¡åº¦ | ä½•æ™‚å‡ç´š |
|------|---------|---------|
| **Workers** | æ¯æ—¥ 100k è«‹æ±‚<br>10ms CPU æ™‚é–“ | ç•¶æ¯æ—¥æµé‡è¶…é 100k æˆ–éœ€è¦æ›´å¤§ CPU è³‡æºæ™‚ï¼Œå‡ç´šåˆ° **Workers Paid ($5/æœˆ)**ã€‚ |
| **KV** | 1 GB å„²å­˜ç©ºé–“<br>æ¯æ—¥ 100k æ¬¡è®€å–<br>æ¯æ—¥ 1k æ¬¡å¯«å…¥ | ç•¶éœ€è¦å„²å­˜å¤§å‹ JSON æˆ–ä¿ç•™é•·æœŸæ­·å²è¨˜éŒ„æ™‚ï¼Œå‡ç´šåˆ°ä»˜è²»æ–¹æ¡ˆã€‚ |
| **D1** | æ¯æœˆ 5M æ¬¡æŸ¥è©¢<br>1 GB å„²å­˜ç©ºé–“ | ç•¶éœ€è¦å¤§é‡ä½¿ç”¨ Top 10 æ’è¡Œæˆ–é•·æ™‚é–“è¶¨å‹¢æŸ¥è©¢æ™‚ï¼Œå‡ç´šåˆ° D1 Paidã€‚ |

> **æ³¨æ„**ï¼šD1 æ˜¯å¯é¸çš„ã€‚å¦‚æœä½ åªéœ€è¦å³æ™‚ PV/UV çµ±è¨ˆï¼ŒKV å·²è¶³å¤ ï¼Œå„€è¡¨æ¿ä¾ç„¶å¯ç”¨ï¼ˆåƒ…ç¼ºå°‘ Top 10 èˆ‡è¶¨å‹¢åœ–ï¼‰ã€‚

å°å¤§å¤šæ•¸å€‹äººç¶²ç«™ä¾†èªªï¼Œå…è²»æ–¹æ¡ˆç¶½ç¶½æœ‰é¤˜ï¼

## API ç«¯é»

éƒ¨ç½²å¾Œï¼Œä½ å¯ä»¥è¨ªå•é€™äº›ç«¯é»ï¼š

```bash
# å¥åº·æª¢æŸ¥
curl https://stats.example.com/health

# é é¢ç€è¦½è¨ˆæ•¸
curl "https://stats.example.com/api/count?url=/posts/example/"

# æ•´é«”çµ±è¨ˆ
curl https://stats.example.com/api/stats

# æ¯æ—¥è¶¨å‹¢
curl https://stats.example.com/api/daily
```

## æ¶æ§‹

```
ç€è¦½å™¨ â†’ Worker (stats.example.com)
          â”œâ”€â”€ /api/*     â†’ çµ±è¨ˆ API
          â”œâ”€â”€ /*         â†’ å„€è¡¨æ¿éœæ…‹æª”æ¡ˆ
          â””â”€â”€ Storage    â†’ Cloudflare KV
```

## å¸¸è¦‹å•é¡Œ

### ç‚ºä»€éº¼ä¸ç”¨ Google Analytics?
è‡ªæ¶æ–¹æ¡ˆè®“ä½ å®Œå…¨æŒæ§è³‡æ–™ï¼Œç„¡éœ€ Cookieï¼Œä¸”ä¸æœƒè¢«å»£å‘Šæ””æˆªå™¨å°é–ã€‚

### å¯ä»¥è‡ªè¨‚å„€è¡¨æ¿å—?
ç•¶ç„¶ï¼å„€è¡¨æ¿åŸå§‹ç¢¼åœ¨ dashboard/ è³‡æ–™å¤¾ï¼Œå¯ä¿®æ”¹ HTML/CSS/JS é…åˆä½ çš„å“ç‰Œé¢¨æ ¼ã€‚

### å¦‚ä½•å‚™ä»½è³‡æ–™?
ä½¿ç”¨å°ˆæ¡ˆæä¾›çš„å‚™ä»½è…³æœ¬ï¼Œå®šæœŸå°‡ KV è³‡æ–™åŒ¯å‡ºåˆ° R2 æˆ– GitHubã€‚

---

é€™å°±æ˜¯ [stats.zakk.au](https://stats.zakk.au/) èƒŒå¾Œçš„æŠ€è¡“æ¶æ§‹ã€‚éƒ¨ç½²å®Œæˆå¾Œï¼Œä½ å°‡æ“æœ‰ï¼š

âœ… è‡ªè¨‚ç¶²åŸŸçš„ç¨ç«‹çµ±è¨ˆå„€è¡¨æ¿  
âœ… å®Œæ•´çš„çµ±è¨ˆ REST API  
âœ… ç„¡ Cookie çš„éš±ç§å„ªå…ˆè¿½è¹¤  

å¦‚æœ‰å•é¡Œï¼Œæ­¡è¿é€ è¨ª [GitHub Issues](https://github.com/Zakkaus/cloudflare-stats-worker/issues)ã€‚
