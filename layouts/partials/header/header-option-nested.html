{{- $item := . -}}
{{- $ctx := . -}}
{{- if and (reflect.IsMap .) (isset . "item") -}}
  {{- $item = index . "item" -}}
  {{- if isset . "ctx" -}}
    {{- $ctx = index . "ctx" -}}
  {{- end -}}
{{- end -}}

{{- $lang := "" -}}
{{- with $ctx -}}
  {{- $lang = .Lang -}}
{{- end -}}

{{- $ctxURL := "" -}}
{{- with $ctx -}}
  {{- with .RelPermalink -}}
    {{- $ctxURL = . -}}
  {{- end -}}
{{- end -}}

{{- $normalizedCtxLang := "" -}}
{{- $trimmed := trim $ctxURL "/" -}}
{{- if $trimmed -}}
  {{- $segments := split $trimmed "/" -}}
  {{- if gt (len $segments) 0 -}}
    {{- $normalizedCtxLang = lower (index $segments 0) -}}
  {{- end -}}
{{- end -}}

{{- if or (not $lang) (and $normalizedCtxLang (ne (lower $lang) $normalizedCtxLang)) -}}
  {{- range site.Languages -}}
    {{- $candidate := lower .Lang -}}
    {{- if or (eq $normalizedCtxLang $candidate) (eq $normalizedCtxLang (lower .LanguageCode)) -}}
      {{- $lang = .Lang -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $site := site -}}
{{- with $ctx -}}
  {{- with .Site -}}
    {{- $site = . -}}
  {{- end -}}
{{- end -}}

{{- $targetSite := $site -}}
{{- if $lang -}}
  {{- range site.Sites -}}
    {{- if eq (lower .Language.Lang) (lower $lang) -}}
      {{- $targetSite = . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $site = $targetSite -}}

{{- $identifier := $item.Identifier -}}
{{- $localizedItem := $item -}}
{{- if and $identifier $site.Menus.main -}}
  {{- range $site.Menus.main -}}
    {{- if eq .Identifier $identifier -}}
      {{- $localizedItem = . -}}
    {{- end -}}
  {{- end -}}
{{- else if and (not $identifier) $item.PageRef $site.Menus.main -}}
  {{- range $site.Menus.main -}}
    {{- if eq .PageRef $item.PageRef -}}
      {{- $localizedItem = . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $item = $localizedItem -}}
{{- $label := $item.Name -}}
{{- $identifier = $item.Identifier -}}
{{- $page := $item.Page -}}
{{- $pageRef := $item.PageRef -}}
{{- $url := $item.URL -}}
{{- $isExternal := or (strings.HasPrefix $url "http:" ) (strings.HasPrefix $url "https:" ) -}}

{{- if $page -}}
  {{- if and $lang (ne (lower $page.Lang) (lower $lang)) -}}
    {{- range $page.Translations -}}
      {{- if eq (lower .Lang) (lower $lang) -}}
        {{- $page = . -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- $url = $page.RelPermalink -}}
  {{- if not $identifier -}}
    {{- $identifier = $page.TranslationKey | default $page.File.TranslationBaseName -}}
  {{- end -}}
{{- else if and $pageRef (not $isExternal) -}}
  {{- $normalized := trim $pageRef "/" -}}
  {{- $prefix := "" -}}
  {{- if and $lang (ne (lower $lang) (lower site.Language.Lang)) -}}
    {{- $prefix = printf "/%s" $lang -}}
  {{- end -}}
  {{- $url = printf "%s/%s/" $prefix $normalized -}}
{{- end -}}

{{- if $page -}}
  {{- $url = $page.RelPermalink -}}
  {{- if not $identifier -}}
    {{- $identifier = $page.TranslationKey | default $page.File.TranslationBaseName -}}
  {{- end -}}
{{- else if and (not $isExternal) $url -}}
  {{- if not (strings.HasPrefix $url "http") -}}
    {{- $normalized := trim $url "/" -}}
    {{- $prefix := "" -}}
    {{- if and $lang (ne (lower $lang) (lower site.Language.Lang)) -}}
      {{- $prefix = printf "/%s" $lang -}}
    {{- end -}}
    {{- $url = printf "%s/%s" $prefix $normalized -}}
    {{- if not (strings.HasSuffix $url "/") -}}
      {{- $url = printf "%s/" $url -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if and (not $label) $page -}}
  {{- $label = $page.LinkTitle | default $page.Title -}}
{{- end -}}

{{- if and $identifier (eq (strings.TrimSpace $label) "") -}}
  {{- $key := printf "menu.%s" $identifier -}}
  {{- $candidate := i18n $key -}}
  {{- if and $candidate (ne $candidate $key) -}}
    {{- $label = $candidate -}}
  {{- end -}}
{{- end -}}

<div>
  <div class="cursor-pointer flex items-center nested-menu">
    {{ if $item.Pre }}
      <span {{ if and $item.Pre $label }}class="mr-1"{{ end }}>
        {{ partial "icon.html" $item.Pre }}
      </span>
    {{ end }}
    <a
      {{ if $url }}
        href="{{ $url }}"
        {{ if $isExternal }}
          target="_blank"
        {{ end }}
      {{ end }}
      class="text-base font-medium hover:text-primary-600 dark:hover:text-primary-400"
      title="{{ if $item.Title }}{{ $item.Title }}{{ else }}{{ $label }}{{ end }}"
      data-menu-lang="{{ if $lang }}{{ $lang }}{{ else }}{{ $site.Language.Lang }}{{ end }}"
      data-menu-id="{{ $identifier }}">
      <p>
        {{ $label | markdownify }}
      </p>
    </a>
    <span>
      {{ partial "icon.html" "chevron-down" }}
    </span>
  </div>
  <div class="absolute menuhide">
    <div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl">
      <div class="flex flex-col space-y-3">
        {{ range $item.Children }}
          {{ partial "header/header-option-simple.html" (dict "item" . "ctx" $ctx) }}
        {{ end }}
      </div>
    </div>
  </div>
</div>
