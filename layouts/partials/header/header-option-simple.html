{{- $label := .Name -}}
{{- $identifier := .Identifier -}}
{{- $page := .Page -}}
{{- $url := .URL -}}
{{- $pageRef := .PageRef -}}
{{- $item := . -}}
{{- $ctx := . -}}
{{- if and (reflect.IsMap .) (isset . "item") -}}
  {{- $item = index . "item" -}}
  {{- if isset . "ctx" -}}
    {{- $ctx = index . "ctx" -}}
  {{- end -}}
{{- end -}}

{{- $site := site -}}
{{- with $ctx.Site -}}
  {{- $site = . -}}
{{- end -}}

{{- $label := $item.Name -}}
{{- $identifier := $item.Identifier -}}
{{- $page := $item.Page -}}
{{- $pageRef := $item.PageRef -}}
{{- $url := $item.URL -}}
{{- $isExternal := or (strings.HasPrefix $url "http:" ) (strings.HasPrefix $url "https:" ) -}}

{{- if $page -}}
  {{- $url = $page.RelPermalink -}}
  {{- if not $identifier -}}
    {{- $identifier = $page.TranslationKey | default $page.File.TranslationBaseName -}}
  {{- end -}}
{{- else if and $pageRef (not $isExternal) -}}
  {{- with $site.GetPage $pageRef -}}
    {{- $page = . -}}
  {{- end -}}
  {{- if not $page -}}
    {{- with $site.GetPage (printf "/%s" $pageRef) -}}
      {{- $page = . -}}
    {{- end -}}
  {{- end -}}
  {{- if not $page -}}
    {{- with $site.GetPage (printf "/%s/%s" $site.Language.Lang $pageRef) -}}
      {{- $page = . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if $page -}}
  {{- $url = $page.RelPermalink -}}
  {{- if not $identifier -}}
    {{- $identifier = $page.TranslationKey | default $page.File.TranslationBaseName -}}
  {{- end -}}
{{- else if and $pageRef (not $isExternal) -}}
  {{- $url = relLangURL (printf "%s/" $pageRef) -}}
{{- else if not $isExternal -}}
  {{- $url = relLangURL $url -}}
{{- end -}}

{{- if and (not $label) $page -}}
  {{- $label = $page.LinkTitle | default $page.Title -}}
{{- end -}}

{{- if $identifier -}}
  {{- $key := printf "menu.%s" $identifier -}}
  {{- $candidate := i18n $key -}}
  {{- if and $candidate (ne $candidate $key) -}}
    {{- $label = $candidate -}}
  {{- end -}}
{{- end -}}

<a
  href="{{ $url }}"
  {{ if $isExternal }}target="_blank"{{ end }}
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  data-menu-lang="{{ $site.Language.Lang }}"
  data-menu-id="{{ $identifier }}">
  {{ if $item.Pre }}
    <span {{ if and $item.Pre $label }}class="mr-1"{{ end }}>
      {{ partial "icon.html" $item.Pre }}
    </span>
  {{ end }}
  <p class="text-base font-medium" title="{{ if $item.Title }}{{ $item.Title }}{{ else }}{{ $label }}{{ end }}">
    {{ $label | markdownify }}
  </p>
</a>
