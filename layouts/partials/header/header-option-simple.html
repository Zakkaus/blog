{{- $item := . -}}
{{- $ctx := . -}}
{{- if and (reflect.IsMap .) (isset . "item") -}}
  {{- $item = index . "item" -}}
  {{- if isset . "ctx" -}}
    {{- $ctx = index . "ctx" -}}
  {{- end -}}
{{- end -}}

{{- $site := site -}}
{{- with $ctx -}}
  {{- with .Site -}}
    {{- $site = . -}}
  {{- end -}}
{{- end -}}

{{- $lang := "" -}}
{{- with $ctx -}}
  {{- $lang = .Lang -}}
{{- end -}}

{{- $ctxURL := "" -}}
{{- with $ctx -}}
  {{- with .RelPermalink -}}
    {{- $ctxURL = . -}}
  {{- end -}}
{{- end -}}

{{- $normalizedCtxLang := "" -}}
{{- $trimmed := trim $ctxURL "/" -}}
{{- if $trimmed -}}
  {{- $segments := split $trimmed "/" -}}
  {{- if gt (len $segments) 0 -}}
    {{- $normalizedCtxLang = lower (index $segments 0) -}}
  {{- end -}}
{{- end -}}

{{- if or (not $lang) (and $normalizedCtxLang (ne (lower $lang) $normalizedCtxLang)) -}}
  {{- range site.Languages -}}
    {{- $candidate := lower .Lang -}}
    {{- if or (eq $normalizedCtxLang $candidate) (eq $normalizedCtxLang (lower .LanguageCode)) -}}
      {{- $lang = .Lang -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $targetSite := $site -}}
{{- if $lang -}}
  {{- range site.Sites -}}
    {{- if eq (lower .Language.Lang) (lower $lang) -}}
      {{- $targetSite = . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $site = $targetSite -}}

{{- $identifier := $item.Identifier -}}
{{- $localizedItem := $item -}}
{{- if and $identifier $site.Menus.main -}}
  {{- range $site.Menus.main -}}
    {{- if eq .Identifier $identifier -}}
      {{- $localizedItem = . -}}
    {{- end -}}
  {{- end -}}
{{- else if and (not $identifier) $item.PageRef $site.Menus.main -}}
  {{- range $site.Menus.main -}}
    {{- if eq .PageRef $item.PageRef -}}
      {{- $localizedItem = . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $item = $localizedItem -}}
{{- $label := $item.Name -}}
{{- $identifier = $item.Identifier -}}
{{- $page := $item.Page -}}
{{- $pageRef := $item.PageRef -}}
{{- $url := $item.URL -}}
{{- $isExternal := or (strings.HasPrefix $url "http:" ) (strings.HasPrefix $url "https:" ) -}}

{{- if $page -}}
  {{- if and $lang (ne (lower $page.Lang) (lower $lang)) -}}
    {{- range $page.Translations -}}
      {{- if eq (lower .Lang) (lower $lang) -}}
        {{- $page = . -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- $url = $page.RelPermalink -}}
  {{- if not $identifier -}}
    {{- $identifier = $page.TranslationKey | default $page.File.TranslationBaseName -}}
  {{- end -}}
{{- else if and $pageRef (not $isExternal) -}}
  {{- with $site.GetPage $pageRef -}}
    {{- $page = . -}}
  {{- end -}}
  {{- if not $page -}}
    {{- with $site.GetPage (printf "/%s" $pageRef) -}}
      {{- $page = . -}}
    {{- end -}}
  {{- end -}}
  {{- if not $page -}}
    {{- if $lang -}}
      {{- with $site.GetPage (printf "/%s/%s" $lang $pageRef) -}}
        {{- $page = . -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if $page -}}
  {{- $url = $page.RelPermalink -}}
  {{- if not $identifier -}}
    {{- $identifier = $page.TranslationKey | default $page.File.TranslationBaseName -}}
  {{- end -}}
{{- else if and $pageRef (not $isExternal) -}}
  {{- $normalized := trim $pageRef "/" -}}
  {{- $url = printf "%s/%s/" (cond (and $lang (ne (lower $lang) (lower site.Language.Lang))) (printf "/%s" $lang) "") $normalized -}}
{{- else if and (not $isExternal) $url -}}
  {{- if strings.HasPrefix $url "http" -}}
    {{- /* leave absolute */ -}}
  {{- else -}}
    {{- $normalized := trim $url "/" -}}
    {{- $url = printf "%s/%s" (cond (and $lang (ne (lower $lang) (lower site.Language.Lang))) (printf "/%s" $lang) "") $normalized -}}
    {{- if not (strings.HasSuffix $url "/") -}}
      {{- $url = printf "%s/" $url -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if and (not $label) $page -}}
  {{- $label = $page.LinkTitle | default $page.Title -}}
{{- end -}}

{{- if and $identifier (eq (strings.TrimSpace $label) "") -}}
  {{- $key := printf "menu.%s" $identifier -}}
  {{- $candidate := i18n $key -}}
  {{- if and $candidate (ne $candidate $key) -}}
    {{- $label = $candidate -}}
  {{- end -}}
{{- end -}}

<a
  href="{{ $url }}"
  {{ if $isExternal }}target="_blank"{{ end }}
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  data-menu-lang="{{ if $lang }}{{ $lang }}{{ else }}{{ $site.Language.Lang }}{{ end }}"
  data-menu-id="{{ $identifier }}">
  {{ if $item.Pre }}
    <span {{ if and $item.Pre $label }}class="mr-1"{{ end }}>
      {{ partial "icon.html" $item.Pre }}
    </span>
  {{ end }}
  <p class="text-base font-medium" title="{{ if $item.Title }}{{ $item.Title }}{{ else }}{{ $label }}{{ end }}">
    {{ $label | markdownify }}
  </p>
</a>
