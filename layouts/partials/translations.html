{{ if and .IsTranslated (hugo.IsMultilingual) }}
  {{ $labels := newScratch }}
  {{ range .Site.Languages }}
    {{ $code := .Lang }}
    {{ $name := .Params.displayName | default .LanguageName | default (upper $code) }}
    {{ $labels.Set $code ($name | emojify) }}
  {{ end }}
  {{ $defaultLang := .Site.Language.Lang }}
  {{ $current := $labels.Get .Lang | default (upper .Lang) }}
  {{ $seenLangs := newScratch }}
  <div>
    <div class="cursor-pointer flex items-center nested-menu">
      <span class="me-1">
        {{ partial "icon.html" "language" }}
      </span>
      <div
        class="text-sm font-medium hover:text-primary-600 dark:hover:text-primary-400"
        title="{{ .Title }}">
        {{- $current -}}
      </div>
    </div>
    <div class="absolute menuhide">
      <div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl">
        <div class="flex flex-col space-y-3">
          {{ range .AllTranslations }}
            {{ $langKey := .Lang }}
            {{ if not ($seenLangs.Get $langKey) }}
              {{ $seenLangs.Set $langKey true }}
              {{ $codeScratch := newScratch }}
              {{ $path := trim .RelPermalink "/" }}
              {{ if $path }}
                {{ $segments := split $path "/" }}
                {{ $candidate := index $segments 0 }}
                {{ with $labels.Get $candidate }}
                  {{ $codeScratch.Set "code" $candidate }}
                {{ end }}
              {{ end }}
              {{ if not ($codeScratch.Get "code") }}
                {{ if ($labels.Get .Lang) }}
                  {{ $codeScratch.Set "code" .Lang }}
                {{ else }}
                  {{ $codeScratch.Set "code" $defaultLang }}
                {{ end }}
              {{ end }}
              {{ $code := $codeScratch.Get "code" }}
              {{ $label := $labels.Get $code | default (upper $code) }}
              {{ $isCurrent := eq (trim .RelPermalink "/") (trim $.RelPermalink "/") }}
              <a href="{{ .RelPermalink }}" class="flex items-center" {{ if $isCurrent }}aria-current="true"{{ end }}>
                <p
                  class="text-sm font-sm hover:text-primary-600 dark:hover:text-primary-400"
                  title="{{ .Title }}">
                  {{- $label -}}
                </p>
              </a>
            {{ end }}
          {{ end }}
        </div>
      </div>
    </div>
  </div>
{{ end }}
