{{- $isZH := eq .Site.Language.Lang "zh-hant" -}}
{{- $home := cond $isZH "/zh-hant/" "/" -}}
{{- $posts := printf "%sposts/" $home -}}
{{- $about := printf "%sabout/" $home -}}
{{- $rel := .RelPermalink -}}
{{- $switch := cond $isZH (replace $rel "/zh-hant/" "/" 1) (printf "/zh-hant%s" $rel) -}}
<header class="site-header" data-build-hash="hdr-v5">
  <div class="site-header-inner">
    <div class="site-brand">
      <a href="{{ $home }}">{{ .Site.Title }}</a>
    </div>

    <nav class="main-nav">
      <ul>
  <li><a href="{{ $home }}" class="{{ if .IsHome }}active{{ end }}">ğŸ  {{ if $isZH }}é¦–é {{ else }}Home{{ end }}</a></li>
  <li><a href="{{ $posts }}" class="{{ if or (eq .Section "posts") (in .RelPermalink "/posts/") }}active{{ end }}">ğŸ“„ {{ if $isZH }}æ–‡ç« {{ else }}Posts{{ end }}</a></li>
  <li><a href="https://help.zakk.au" target="_blank" rel="noopener">ğŸ“ {{ if $isZH }}å­¸ç”Ÿ{{ else }}Students{{ end }}</a></li>
  <li><a href="{{ $about }}" class="{{ if in .RelPermalink "/about/" }}active{{ end }}">â„¹ï¸ {{ if $isZH }}é—œæ–¼{{ else }}About{{ end }}</a></li>
      </ul>
    </nav>

    <div class="top-action-group">
      <div class="custom-topbuttons">
        <div class="cb-menu">
          <a class="cb-btn lang-switch" href="{{ $switch }}">ğŸŒ {{ if $isZH }}English{{ else }}æ¼¢èª{{ end }}</a>
          <button class="cb-btn" id="themeToggle" type="button">ğŸŒ“ {{ if $isZH }}é»‘æš—{{ else }}Dark{{ end }}</button>
        </div>
      </div>

      <button class="cb-toggle mobile-only"
              aria-label="Menu"
              aria-controls="mobileMenu"
              onclick="document.getElementById('mobileMenu').classList.toggle('open')">â˜°</button>

      <div id="mobileMenu" class="cb-menu mobile-only">
        <a class="cb-btn" href="{{ $home }}">ğŸ  {{ if $isZH }}é¦–é {{ else }}Home{{ end }}</a>
        <a class="cb-btn" href="{{ $posts }}">ğŸ“„ {{ if $isZH }}æ–‡ç« {{ else }}Posts{{ end }}</a>
        <a class="cb-btn" href="https://help.zakk.au" target="_blank" rel="noopener">ğŸ“ {{ if $isZH }}å­¸ç”Ÿ{{ else }}Students{{ end }}</a>
        <a class="cb-btn" href="{{ $about }}">â„¹ï¸ {{ if $isZH }}é—œæ–¼{{ else }}About{{ end }}</a>
      </div>
    </div>
  </div>
</header>

<!-- ä¸»é¡Œåˆ‡æ›ï¼ˆä¿æŒä¸è®Šï¼‰ -->
<script>
(function(){
  if (window.__THEME_TOGGLE_INIT) return;
  window.__THEME_TOGGLE_INIT = true;
  const root=document.documentElement, body=document.body;
  const isZH=(root.lang||'').toLowerCase().startsWith('zh');
  const KEY='site-theme', btn=document.getElementById('themeToggle');
  function sysPref(){return matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light';}
  function nextLabel(next){return isZH?(next==='dark'?'ğŸŒ“ é»‘æš—':'ğŸŒ æ˜äº®'):(next==='dark'?'ğŸŒ“ Dark':'ğŸŒ Light');}
  function updateLabel(cur){ if(!btn)return; const nxt=cur==='dark'?'light':'dark'; btn.textContent=nextLabel(nxt); }
  function apply(mode){ const dark=mode==='dark'; root.classList.toggle('dark',dark); body.classList.toggle('dark',dark); updateLabel(mode); }
  function toggle(){ const target=root.classList.contains('dark')?'light':'dark'; apply(target); localStorage.setItem(KEY,target); }
  apply(localStorage.getItem(KEY)||sysPref());
  btn&&btn.addEventListener('click',toggle);
  addEventListener('resize',()=>{ if(innerWidth>900){ const m=document.getElementById('mobileMenu'); m&&m.classList.remove('open'); }});
})();
</script>

<!-- å¼·åŒ–æ¸…ç†ï¼šæ–°å¢æ‹¬è™Ÿæ®˜ç¢¼ pattern -->
<script>
(function(){
  const PAT_LIST = [
    /nowDark\s*\?\s*'light':'dark'/,
    /m\.classList\.remove\('open'\)/,
    /const\s+target\s*=\s*nowDark/,
    /apply\(target\)/,
    /\}\);\s*\}\)\(\);\s*$/  // æ•æ‰ "}); })();"
  ];
  function sweep(limit){
    let removed=0;
    const walker=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null);
    const del=[];
    while(walker.nextNode()){
      const n=walker.currentNode;
      const txt=n.textContent.trim();
      if(!txt) continue;
      if(txt.length<600 && PAT_LIST.some(p=>p.test(txt))){
        del.push(n);
      }
    }
    del.forEach(n=>{ n.parentNode && n.parentNode.removeChild(n); removed++; });
    if(removed) console.warn('[header sanitize] removed stray nodes:',removed);
    if(limit>0) setTimeout(()=>sweep(limit-1),150);
  }
  // å¤šè¼ª
  sweep(8);
  // Mutation ç›£æ§çŸ­æœŸæ³¨å…¥
  const mo=new MutationObserver(()=>sweep(0));
  mo.observe(document.body,{childList:true,subtree:true});
  setTimeout(()=>mo.disconnect(),4000);
})();
</script>
<!-- END header partial -->
</script>

<!-- è‡ªå‹•æ¸…ç† & è¨ºæ–·ï¼šç§»é™¤ä»»ä½•æ®˜ç•™èˆŠ JS ç´”æ–‡å­— -->
<script>
(function(){
  const PATTERNS = [
    /nowDark\s*\?\s*'light':'dark'/,
    /apply\(target\)/,
    /toggleTheme/,
    /const\s+target\s*=\s*nowDark/
  ];
  let removed = 0;
  const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
  const badNodes = [];
  while(walker.nextNode()){
    const n = walker.currentNode;
    const t = n.textContent.trim();
    if(!t) continue;
    if(PATTERNS.some(p=>p.test(t))){
      badNodes.push(n);
    }
  }
  badNodes.forEach(n=>{
    removed++;
    n.parentNode.removeChild(n);
  });
  if(removed){
    console.warn('[header-cleanup] removed stray script text nodes:', removed);
  }
})();
</script>

<!-- å¼·åŒ–æ¸…ç†è…³æœ¬ -->
<script>
(function(){
  // ç§»é™¤é é¢ä¸­çš„å¤–éœ²è…³æœ¬æ–‡å­—
  function cleanupStrayText() {
    const body = document.body;
    const walker = document.createTreeWalker(
      body,
      NodeFilter.SHOW_TEXT,
      null,
      false
    );
    
    const strayPatterns = [
      /\}\);\s*\}\);\s*\}\s*\}\)\(\);\s*\}\)\(\);/,
      /Â©.*Hugo.*PaperMod.*\}\)/,
      /document\.createElement/,
      /custom-topbuttons-css/
    ];
    
    const nodesToRemove = [];
    
    while (walker.nextNode()) {
      const node = walker.currentNode;
      const text = node.textContent.trim();
      
      if (text && strayPatterns.some(pattern => pattern.test(text))) {
        nodesToRemove.push(node);
      }
    }
    
    nodesToRemove.forEach(node => {
      if (node.parentNode) {
        node.parentNode.removeChild(node);
      }
    });
    
    if (nodesToRemove.length > 0) {
      console.log('æ¸…ç†äº†', nodesToRemove.length, 'å€‹å¤–éœ²æ–‡å­—ç¯€é»');
    }
  }
  
  // ç«‹å³æ¸…ç†
  cleanupStrayText();
  
  // å»¶é²æ¸…ç†ï¼ˆè™•ç†å‹•æ…‹æ’å…¥çš„å…§å®¹ï¼‰
  setTimeout(cleanupStrayText, 100);
  setTimeout(cleanupStrayText, 500);
  
  // ç›£è½ DOM è®ŠåŒ–
  const observer = new MutationObserver(cleanupStrayText);
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
  
  // 2ç§’å¾Œåœæ­¢ç›£è½
  setTimeout(() => observer.disconnect(), 2000);
})();
</script>

<!-- END header partial (æª¢æŸ¥é»ï¼šè‹¥å†æ¬¡å‡ºç¾å¤–éœ²æ–‡å­—ï¼Œè«‹å…¨æ–‡ grep `nowDark ? 'light'` æˆ– `const target = nowDark`) -->
